name: ðŸ”„ CI

on:
  push:
    branches: [master, feature/*]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
  pull_request:
    branches: [master]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: ðŸŽ¨ Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: ðŸ“¦ Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: ðŸŽ¨ Check formatting
        run: cargo fmt --all -- --check

      - name: ðŸ“Ž Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: ðŸ§ª Test & Coverage
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: ðŸ“¦ Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: ðŸ“¦ Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: ðŸ§ª Run tests with coverage
        run: |
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info \
            --ignore-filename-regex '(tools/|/bin/|main\.rs$)'

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: ðŸ“Š Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(cargo llvm-cov --all-features --workspace --json \
            --ignore-filename-regex '(tools/|/bin/|main\.rs$)' \
            | jq '.data[0].totals.lines.percent' | cut -d. -f1)
          echo "percent=$COVERAGE" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Update coverage badge
        if: github.ref == 'refs/heads/master'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ secrets.BADGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percent }}%
          valColorRange: ${{ steps.coverage.outputs.percent }}
          maxColorRange: 100
          minColorRange: 0

  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“¦ Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: ðŸ”¨ Build release
        run: cargo build --release

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: redirector-linux-amd64
          path: target/release/redirector
          retention-days: 7

  benchmark:
    name: ðŸŽï¸ Benchmark
    runs-on: ubuntu-latest
    needs: [test, build]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: redirector-linux-amd64
          path: ./bin

      - name: ðŸ”§ Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk redis-tools

      - name: ðŸ—„ï¸ Setup database
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -c "
            CREATE SCHEMA IF NOT EXISTS dictionary;
            CREATE TABLE dictionary.urls (id BIGINT PRIMARY KEY, name VARCHAR(4096) NOT NULL);
            INSERT INTO dictionary.urls (id, name) SELECT i, 'https://example.com/page' || i FROM generate_series(1, 10000) i;
          "

      - name: ðŸ—„ï¸ Setup Redis cache
        run: |
          for i in $(seq 1 1000); do
            redis-cli SET "url:$i" "https://example.com/page$i" EX 3600
          done

      - name: ðŸš€ Start service
        run: |
          chmod +x ./bin/redirector
          ./bin/redirector &
          sleep 3
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/test"
          REDIS_URL: "redis://localhost:6379"
          HASHIDS_SALTS: "test-salt-for-load-testing"
          METRICS_USERNAME: "prometheus"
          METRICS_PASSWORD: "secret"
          HOST: "0.0.0.0"
          PORT: "8080"
          HASHIDS_MIN_LENGTH: "6"
          REDIS_CACHE_TTL: "3600"
          DB_MAX_CONNECTIONS: "5"
          DB_CONNECT_TIMEOUT: "5"
          DB_RPS: "10000"
          CB_FAILURE_THRESHOLD: "5"
          CB_RESET_TIMEOUT: "30"
          DB_TABLE: "dictionary.urls"
          DB_ID_COLUMN: "id"
          DB_URL_COLUMN: "name"
          INTERSTITIAL_DELAY: "5"
          RATE_LIMIT_RPS: "50000"
          RATE_LIMIT_BURST: "1000"

      - name: ðŸ”— Generate test hashids
        run: |
          cd tests/loadtest
          cat sample_hashids_100.txt > cache_test.txt
          head -1000 sample_hashids_10000.txt > mixed_test.txt

      - name: ðŸŽï¸ Run cache hit benchmark
        id: cache_bench
        run: |
          cd tests/loadtest
          RESULT=$(wrk -t4 -c100 -d30s -s loadtest.lua http://localhost:8080 -- cache_test.txt 2>&1)
          echo "$RESULT"

          RPS=$(echo "$RESULT" | grep "Requests/sec" | awk '{print $2}' | cut -d. -f1)
          LATENCY=$(echo "$RESULT" | grep "Latency" | awk '{print $2}')

          echo "cache_rps=$RPS" >> $GITHUB_OUTPUT
          echo "cache_latency=$LATENCY" >> $GITHUB_OUTPUT

      - name: ðŸŽï¸ Run mixed load benchmark
        id: mixed_bench
        run: |
          cd tests/loadtest
          RESULT=$(wrk -t4 -c100 -d30s -s loadtest.lua http://localhost:8080 -- mixed_test.txt 2>&1)
          echo "$RESULT"

          RPS=$(echo "$RESULT" | grep "Requests/sec" | awk '{print $2}' | cut -d. -f1)
          echo "mixed_rps=$RPS" >> $GITHUB_OUTPUT

      - name: ðŸ“ˆ Get metrics
        id: metrics
        run: |
          METRICS=$(curl -s -u prometheus:secret http://localhost:8080/metrics)
          echo "$METRICS"

          HITS=$(echo "$METRICS" | grep '^cache_hits_total' | awk '{print $2}' || echo "0")
          MISSES=$(echo "$METRICS" | grep '^cache_misses_total' | awk '{print $2}' || echo "0")

          if [ -n "$HITS" ] && [ -n "$MISSES" ] && [ "$HITS" != "0" -o "$MISSES" != "0" ]; then
            TOTAL=$((${HITS%.*} + ${MISSES%.*}))
            if [ "$TOTAL" -gt 0 ]; then
              RATE=$((${HITS%.*} * 100 / $TOTAL))
            else
              RATE=0
            fi
          else
            RATE=0
          fi

          echo "cache_hit_rate=$RATE" >> $GITHUB_OUTPUT

      - name: ðŸ… Update performance badges
        if: github.ref == 'refs/heads/master'
        run: |
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/${{ secrets.BADGE_GIST_ID }} \
            -d "{\"files\":{\"rps.json\":{\"content\":\"{\\\"schemaVersion\\\":1,\\\"label\\\":\\\"RPS\\\",\\\"message\\\":\\\"${{ steps.cache_bench.outputs.cache_rps }}\\\",\\\"color\\\":\\\"blue\\\"}\"}}}"

          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/${{ secrets.BADGE_GIST_ID }} \
            -d "{\"files\":{\"latency.json\":{\"content\":\"{\\\"schemaVersion\\\":1,\\\"label\\\":\\\"latency\\\",\\\"message\\\":\\\"${{ steps.cache_bench.outputs.cache_latency }}\\\",\\\"color\\\":\\\"green\\\"}\"}}}"

          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/${{ secrets.BADGE_GIST_ID }} \
            -d "{\"files\":{\"cache_hit_rate.json\":{\"content\":\"{\\\"schemaVersion\\\":1,\\\"label\\\":\\\"cache hit\\\",\\\"message\\\":\\\"${{ steps.metrics.outputs.cache_hit_rate }}%\\\",\\\"color\\\":\\\"brightgreen\\\"}\"}}}"

      - name: ðŸ“‹ Print benchmark summary
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Hit RPS | ${{ steps.cache_bench.outputs.cache_rps }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Hit Latency | ${{ steps.cache_bench.outputs.cache_latency }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mixed Load RPS | ${{ steps.mixed_bench.outputs.mixed_rps }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Hit Rate | ${{ steps.metrics.outputs.cache_hit_rate }}% |" >> $GITHUB_STEP_SUMMARY
