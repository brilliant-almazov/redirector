# redirector

[English](../README.md) | **ะัััะบะธะน**

[![CI](https://github.com/brilliant-almazov/redirector/actions/workflows/ci.yaml/badge.svg)](https://github.com/brilliant-almazov/redirector/actions/workflows/ci.yaml)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

ะะตะทะพะฟะฐัะฝัะน ัะตัะฒะธั ัะตะดะธัะตะบัะพะฒ ั ะฟัะพะผะตะถััะพัะฝัะผะธ ัััะฐะฝะธัะฐะผะธ ะธ ะบะพัะพัะบะธะผะธ ัััะปะบะฐะผะธ ะฝะฐ ะพัะฝะพะฒะต hashid.

### ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

| ะกัะตะฝะฐัะธะน | RPS | ะกัะตะดะฝ. ะทะฐะดะตัะถะบะฐ | P99 ะทะฐะดะตัะถะบะฐ |
|----------|-----|-----------------|--------------|
| 100% Cache Hit | **7,800+** | ~14ms | ~50ms |
| Cache Miss (10K URLs) | **2,300+** | ~44ms | ~81ms |

**ะฃัะปะพะฒะธั ัะตััะฐ**: wrk -t4 -c100 -d30s, PostgreSQL 15, Dragonfly (Redis), macOS M1

ะกะผ. [tests/loadtest/](../tests/loadtest/) ะดะปั ัะบัะธะฟัะพะฒ ะฝะฐะณััะทะพัะฝะพะณะพ ัะตััะธัะพะฒะฐะฝะธั.

## ะัะพะฑะปะตะผะฐ

ะะตะปะธัััั ะดะปะธะฝะฝัะผะธ URL ะฝะตัะดะพะฑะฝะพ. ะกะพะบัะฐัะฐัะตะปะธ ัััะปะพะบ ัััะตััะฒััั, ะฝะพ ัะฐััะพ ะฟะตัะตะฝะฐะฟัะฐะฒะปััั ะผะณะฝะพะฒะตะฝะฝะพ, ััะพ ะผะพะถะตั ะฑััั ะฝะตะฑะตะทะพะฟะฐัะฝะพ. ะะพะปัะทะพะฒะฐัะตะปะธ ะดะพะปะถะฝั ะฒะธะดะตัั, ะบัะดะฐ ะธั ะฟะตัะตะฝะฐะฟัะฐะฒะปััั, ะฟัะตะถะดะต ัะตะผ ะฟะตัะตะนัะธ.

**redirector** ะพะฑะตัะฟะตัะธะฒะฐะตั ะฑะตะทะพะฟะฐัะฝัะต ัะตะดะธัะตะบัั:
- ะัะพะผะตะถััะพัะฝะฐั ัััะฐะฝะธัะฐ ะฟะพะบะฐะทัะฒะฐะตั ัะตะปะตะฒะพะน URL ะฟะตัะตะด ัะตะดะธัะตะบัะพะผ
- ะะฑัะฐัะฝัะน ะพััััั ะดะปั ะพัะฒะตะดะพะผะปัะฝะฝะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปั
- ะัะฐัะธะฒัะต, ะฑัะตะฝะดะธัะพะฒะฐะฝะฝัะต ัััะฐะฝะธัั

## ะะพะทะผะพะถะฝะพััะธ

- ๐ **Hashid URL** - ะะพัะพัะบะธะต, ัะฝะธะบะฐะปัะฝัะต, ะฝะตะฟะพัะปะตะดะพะฒะฐัะตะปัะฝัะต ID (ะฝะฐะฟัะธะผะตั, `/abc123`)
- โฑ๏ธ **ะัะพะผะตะถััะพัะฝะฐั ัััะฐะฝะธัะฐ** - ะะฑัะฐัะฝัะน ะพััััั ะฟะพะบะฐะทัะฒะฐะตั ัะตะปะตะฒะพะน URL ะฟะตัะตะด ัะตะดะธัะตะบัะพะผ
- โก **ะััะธัะพะฒะฐะฝะธะต Redis** - ะัััััะต ะทะฐะฟัะพัั ั ะฝะฐัััะฐะธะฒะฐะตะผัะผ TTL
- ๐ก๏ธ **Circuit breaker** - ะะฐัะธัะฐ ะะ ะพั ะบะฐัะบะฐะดะฝัั ัะฑะพะตะฒ
- ๐ฆ **Rate limiting** - ะะปะพะฑะฐะปัะฝัะน ะธ ะฝะฐ ััะพะฒะฝะต ะะ
- ๐ **Prometheus ะผะตััะธะบะธ** - ะะพะปะฝะฐั ะฝะฐะฑะปัะดะฐะตะผะพััั ั Basic Auth ะทะฐัะธัะพะน
- ๐จ **ะัะฐัะธะฒัะต ัััะฐะฝะธัั** - ะงะธัััะต ัััะฐะฝะธัั 404 ะธ ะธะฝะดะตะบัะฐ
- ๐ **ะะตัะบะพะปัะบะพ ัะพะปะตะน** - ะะพะดะดะตัะถะบะฐ ัะพัะฐัะธะธ ัะพะปะธ hashid ะดะปั ะผะธะณัะฐัะธะธ

## ะัััััะน ััะฐัั

### Docker

```bash
docker run -p 8080:8080 \
  -v $(pwd)/config.yaml:/config.yaml \
  ghcr.io/brilliant-almazov/redirector:latest
```

### Docker Compose

```yaml
services:
  redirector:
    image: ghcr.io/brilliant-almazov/redirector:latest
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config.yaml
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: redirector
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: redirector

  redis:
    image: redis:7-alpine
```

## ะะพะฝัะธะณััะฐัะธั

ะกะพะทะดะฐะนัะต `config.yaml`:

```yaml
server:
  host: "0.0.0.0"
  port: 8080

hashids:
  salts:
    - ${HASHID_SALT}          # ะัะฝะพะฒะฝะฐั ัะพะปั
    - ${HASHID_SALT_OLD}      # ะะฟัะธะพะฝะฐะปัะฝะพ: ััะฐัะฐั ัะพะปั ะดะปั ะผะธะณัะฐัะธะธ
  min_length: 6

redis:
  url: ${REDIS_URL}
  cache_ttl_seconds: 86400    # 24 ัะฐัะฐ

database:
  url: ${DATABASE_URL}
  pool:
    max_connections: 5
    connect_timeout_seconds: 3
  rate_limit:
    max_requests_per_second: 50
  circuit_breaker:
    failure_threshold: 3
    reset_timeout_seconds: 60
  query:
    table: "dictionary.urls"    # ะะผั ัะฐะฑะปะธัั
    id_column: "id"             # ะะพะปะพะฝะบะฐ ID
    url_column: "name"          # ะะพะปะพะฝะบะฐ URL

interstitial:
  delay_seconds: 5            # ะััััั ะฟะตัะตะด ัะตะดะธัะตะบัะพะผ

metrics:
  basic_auth:
    username: prometheus
    password: ${METRICS_PASSWORD}

rate_limit:
  requests_per_second: 1000
  burst: 100
```

### ะะฐัะฐะผะตััั ะบะพะฝัะธะณััะฐัะธะธ

#### ะกะตัะฒะตั

| ะะฐัะฐะผะตัั | ะะพ ัะผะพะปัะฐะฝะธั | ะะฟะธัะฐะฝะธะต |
|----------|--------------|----------|
| `host` | `0.0.0.0` | ะะดัะตั ะฟัะธะฒัะทะบะธ |
| `port` | `8080` | HTTP ะฟะพัั |

#### Hashids

| ะะฐัะฐะผะตัั | ะะพ ัะผะพะปัะฐะฝะธั | ะะฟะธัะฐะฝะธะต |
|----------|--------------|----------|
| `salts` | *ะพะฑัะทะฐัะตะปัะฝะพ* | ะกะฟะธัะพะบ ัะพะปะตะน hashid (ะฟะตัะฒะฐั = ะพัะฝะพะฒะฝะฐั) |
| `min_length` | `6` | ะะธะฝะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ hashid |

#### Redis

| ะะฐัะฐะผะตัั | ะะพ ัะผะพะปัะฐะฝะธั | ะะฟะธัะฐะฝะธะต |
|----------|--------------|----------|
| `url` | *ะพะฑัะทะฐัะตะปัะฝะพ* | URL ะฟะพะดะบะปััะตะฝะธั ะบ Redis |
| `cache_ttl_seconds` | `86400` | TTL ะบััะฐ ะฒ ัะตะบัะฝะดะฐั |

#### ะะฐะทะฐ ะดะฐะฝะฝัั

| ะะฐัะฐะผะตัั | ะะพ ัะผะพะปัะฐะฝะธั | ะะฟะธัะฐะฝะธะต |
|----------|--------------|----------|
| `url` | *ะพะฑัะทะฐัะตะปัะฝะพ* | URL ะฟะพะดะบะปััะตะฝะธั ะบ PostgreSQL |
| `pool.max_connections` | `3` | ะะฐะทะผะตั ะฟัะปะฐ ัะพะตะดะธะฝะตะฝะธะน |
| `pool.connect_timeout_seconds` | `3` | ะขะฐะนะผะฐัั ะฟะพะดะบะปััะตะฝะธั |
| `rate_limit.max_requests_per_second` | `50` | Rate limit ะะ |
| `circuit_breaker.failure_threshold` | `3` | ะกะฑะพะตะฒ ะดะพ ะพัะบัััะธั |
| `circuit_breaker.reset_timeout_seconds` | `60` | ะขะฐะนะผะฐัั ัะฑัะพัะฐ circuit |

#### Rate Limit (ะณะปะพะฑะฐะปัะฝัะน)

| ะะฐัะฐะผะตัั | ะะพ ัะผะพะปัะฐะฝะธั | ะะฟะธัะฐะฝะธะต |
|----------|--------------|----------|
| `requests_per_second` | `1000` | ะะปะพะฑะฐะปัะฝัะน rate limit |
| `burst` | `100` | ะะฐะทะผะตั ะฒัะฟะปะตัะบะฐ |

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะัะต ะทะฝะฐัะตะฝะธั ะบะพะฝัะธะณััะฐัะธะธ ะฟะพะดะดะตัะถะธะฒะฐัั ะฟะพะดััะฐะฝะพะฒะบั `${VAR}`. ะะพะฟะพะปะฝะธัะตะปัะฝะพ:

- `CONFIG_FILE` - ะััั ะบ ัะฐะนะปั ะบะพะฝัะธะณััะฐัะธะธ (ะฟะพ ัะผะพะปัะฐะฝะธั: `config.yaml`)

## ะะฐะทะฐ ะดะฐะฝะฝัั

ะกะตัะฒะธัั ะฝัะถะฝะฐ ะฟัะพััะฐั ัะฒัะทั: **ID โ URL**

ะกะตะนัะฐั ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝัะน ะทะฐะฟัะพั ะดะปั ัะฐะฑะปะธั `dictionary.urls` + `dictionary.domains`.

> **ะกะบะพัะพ**: ะะพะฝัะธะณััะธััะตะผะฐั ััััะบัััะฐ ะทะฐะฟัะพัะฐ. ะะพะถะฝะพ ะฑัะดะตั ะดะตะบะปะฐัะฐัะธะฒะฝะพ ัะบะฐะทะฐัั ัะฒะพะธ ะบะพะปะพะฝะบะธ ID ะธ URL, ะฝะตะทะฐะฒะธัะธะผะพ ะพั ััะตะผั ะะ.

## ะญะฝะดะฟะพะธะฝัั

| ะญะฝะดะฟะพะธะฝั | ะะฒัะพัะธะทะฐัะธั | ะะฟะธัะฐะฝะธะต |
|----------|-------------|----------|
| `GET /` | ะะตั | ะะปะฐะฒะฝะฐั ัััะฐะฝะธัะฐ |
| `GET /{hashid}` | ะะตั | ะะตะดะธัะตะบั ั ะฟัะพะผะตะถััะพัะฝะพะน ัััะฐะฝะธัะตะน |
| `GET /health` | ะะตั | ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั |
| `GET /metrics` | Basic | Prometheus ะผะตััะธะบะธ |

## ะะตััะธะบะธ

ะกะตัะฒะธั ะฟัะตะดะพััะฐะฒะปัะตั Prometheus ะผะตััะธะบะธ ะฝะฐ `/metrics` (ััะตะฑัะตััั Basic Auth):

### ะะตััะธะบะธ ัะตัะฒะธัะฐ
```
redirector_up 1
redirector_build_info{version="0.1.0"} 1
redirector_uptime_seconds 3600.5
```

### ะะตััะธะบะธ ะทะฐะฟัะพัะพะฒ
```
redirect_requests_total 150000
not_found_requests_total 50
request_duration_seconds{quantile="0.5"} 0.040
request_duration_seconds{quantile="0.99"} 0.081
```

### ะะตััะธะบะธ ะบััะฐ
```
cache_hits_total 140000
cache_misses_total 10000
cache_get_duration_seconds{quantile="0.5"} 0.002
cache_set_duration_seconds{quantile="0.5"} 0.002
```

### ะะตััะธะบะธ ะะ
```
db_queries_total 10000
db_hits_total 9950
db_misses_total 50
db_query_duration_seconds{quantile="0.5"} 0.035
db_rate_limit_exceeded_total 0
circuit_breaker_rejections_total 0
```

## ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. ะะพะปัะทะพะฒะฐัะตะปั ะฟะพัะตัะฐะตั `/{hashid}` (ะฝะฐะฟัะธะผะตั, `/abc123`)
2. ะกะตัะฒะธั ะดะตะบะพะดะธััะตั hashid ะฒ ัะธัะปะพะฒะพะน ID
3. ะัะพะฒะตััะตั ะบัั Redis ะฝะฐ ะฝะฐะปะธัะธะต URL
4. ะัะธ ะฟัะพะผะฐัะต ะบััะฐ โ ะทะฐะฟัะพั ะบ PostgreSQL
5. ะััะธััะตั ัะตะทัะปััะฐั ะฒ Redis
6. ะะพะบะฐะทัะฒะฐะตั ะฟัะพะผะตะถััะพัะฝัั ัััะฐะฝะธัั ั ะพัััััะพะผ
7. ะะพัะปะต ะพัััััะฐ ัะตะดะธัะตะบัะธั ะฝะฐ ัะตะปะตะฒะพะน URL

```
โโโโโโโโ     โโโโโโโโโโโโโ     โโโโโโโโโ     โโโโโโโโโโโโ
โะะปะธะตะฝัโโโโโโถโRedirector โโโโโโถโ Redis โโโโโโถโPostgreSQLโ
โโโโโโโโ     โโโโโโโโโโโโโ     โโโโโโโโโ     โโโโโโโโโโโโ
                  โ
                  โผ
           โโโโโโโโโโโโโโโ
           โะัะพะผะตะถััะพัะฝะฐัโ
           โ  ัััะฐะฝะธัะฐ   โ
           โโโโโโโโโโโโโโโ
```

## ะกะฑะพัะบะฐ

```bash
# ะกะฑะพัะบะฐ
cargo build --release

# ะะฐะฟััะบ ัะตััะพะฒ
cargo test

# ะะฐะฟััะบ ั ะฟะพะบัััะธะตะผ
cargo llvm-cov --text

# ะัะพะฒะตัะบะฐ ััะธะปั ะบะพะดะฐ
cargo fmt --all -- --check
cargo clippy --all-targets --all-features -- -D warnings
```

## ะะธัะตะฝะทะธั

MIT License - ะฟะพะดัะพะฑะฝะพััะธ ะฒ [LICENSE](../LICENSE).

## ะฃัะฐััะธะต ะฒ ัะฐะทัะฐะฑะพัะบะต

ะะบะปะฐะด ะฟัะธะฒะตัััะฒัะตััั! ะะพะถะฐะปัะนััะฐ:

1. ะคะพัะบะฝะธัะต ัะตะฟะพะทะธัะพัะธะน
2. ะกะพะทะดะฐะนัะต feature-ะฒะตัะบั
3. ะัะฟัะฐะฒััะต Pull Request

ะะฐัะธััะฝะฝะฐั master-ะฒะตัะบะฐ ััะตะฑัะตั ัะตะฒัั PR.
